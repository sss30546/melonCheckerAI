#!/usr/bin/env python3
import os
import json
import streamlit as st
from groq import Groq
from dotenv import load_dotenv

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤ ENV
load_dotenv(".env")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
client = Groq(api_key=GROQ_API_KEY)

st.set_page_config(page_title="üçã Lemon Disease AI Bot", page_icon="üçã", layout="wide")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏ï‡∏ö‡∏≠‡∏ï
def chatboot(question):
    system_prompt = """
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡πÄ‡∏•‡∏°‡∏≠‡∏ô (Lemon)"  
‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏°‡∏≠‡∏ô‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡πÉ‡∏î‡πÉ‡∏ô 3 ‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏µ‡πâ  
‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢

**‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡πÑ‡∏î‡πâ:**
1. **‡πÇ‡∏£‡∏Ñ‡πÅ‡∏Ñ‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå (Citrus Canker)**  
   - ‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ô‡∏π‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏•‡πâ‡∏≠‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏á‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á  
   - ‡πÅ‡∏ú‡∏•‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏≤‡∏ö ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏ö‡∏à‡∏∞‡∏™‡∏≤‡∏Å‡∏°‡∏∑‡∏≠  
   - ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏ö‡∏Ñ‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢ *Xanthomonas citri*  
   - ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ, ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏Ñ‡∏≠‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå

2. **‡πÇ‡∏£‡∏Ñ‡∏™‡πÅ‡∏Ñ‡∏ö (Citrus Scab)**  
   - ‡πÉ‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏ï‡∏∏‡πà‡∏°‡∏ô‡∏π‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏™‡∏∞‡πÄ‡∏Å‡πá‡∏î  
   - ‡πÅ‡∏ú‡∏•‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á  
   - ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤ *Elsino√´ fawcetti*  
   - ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡∏û‡πà‡∏ô‡∏™‡∏≤‡∏£‡πÅ‡∏°‡∏ô‡πÇ‡∏Ñ‡πÄ‡∏ã‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå

3. **‡πÇ‡∏£‡∏Ñ‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™ (Anthracnose)**  
   - ‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏î‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πâ‡∏° ‡πÅ‡∏ú‡∏•‡πÅ‡∏´‡πâ‡∏á ‡∏ú‡∏•‡∏£‡πà‡∏ß‡∏á‡∏á‡πà‡∏≤‡∏¢  
   - ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤ *Colletotrichum gloeosporioides*  
   - ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡∏≠‡∏≠‡∏Å, ‡∏û‡πà‡∏ô‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤

**‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:**
‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ:
{
  "disease": "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
  "‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
  "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö": "‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
  "‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô": "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°",
  "reason": "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"
}
"""
    response = client.chat.completions.create(
        model="llama-3.1-8b-instant",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": question},
        ],
        temperature=0.3,
        max_tokens=1024,
    )
    return response.choices[0].message.content.strip()


# ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
def main():
    st.markdown("""
        <style>
        /* ‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏Ç‡∏≠‡∏ö */
        .chat-bubble {
            background-color: #f0f2f6;
            padding: 12px 18px;
            border-radius: 12px;
            margin-bottom: 10px;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 16px;
            line-height: 1.5;
        }
        .chat-user {
            background-color: #e8ffe8;
        }
        .chat-bot {
            background-color: #fff6e6;
        }
        .stTextInput > div > div > input {
            font-size: 16px !important;
        }
        </style>
    """, unsafe_allow_html=True)

    st.title("üçã Preliminary Lemon Disease Checker Chatbot")
    st.subheader("‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏°‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∞‡πÑ‡∏£")

    if "messages" not in st.session_state:
        st.session_state["messages"] = [
            {"role": "assistant", "content": (
                "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏à‡πâ‡∏≤ üçã ‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ä‡∏ï‡∏ö‡∏≠‡∏ï‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡πÄ‡∏•‡∏°‡∏≠‡∏ô "
                "3 ‡πÇ‡∏£‡∏Ñ ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà Citrus canker, Citrus scab, Anthracnose\n\n"
                "üü¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô:\n"
                "- ‡πÉ‡∏ö‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ô‡∏π‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á\n"
                "- ‡∏ú‡∏•‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÅ‡∏ú‡∏•‡πÅ‡∏´‡πâ‡∏á‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏Ç‡πâ‡∏°\n"
                "- ‡∏Å‡∏¥‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß\n\n"
                "‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢!"
            )}
        ]

    with st.form("chat_form"):
        query = st.text_input("üó£Ô∏è ‡∏Ñ‡∏∏‡∏ì:", placeholder="‡πÄ‡∏ä‡πà‡∏ô '‡πÉ‡∏ö‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ô‡∏π‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÜ'").strip()
        submitted = st.form_submit_button("üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°")

        if submitted and query:
            answer = chatboot(query)
            st.session_state["messages"].append({"role": "user", "content": query})
            st.session_state["messages"].append({"role": "assistant", "content": answer})
        elif submitted and not query:
            st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á")

    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    for msg in st.session_state["messages"]:
        if msg["role"] == "user":
            st.markdown(f"<div class='chat-bubble chat-user'><b>üßë‚Äçüåæ ‡∏Ñ‡∏∏‡∏ì:</b> {msg['content']}</div>", unsafe_allow_html=True)
        else:
            try:
                data = json.loads(msg["content"])
                html = f"""
                <div class='chat-bubble chat-bot'>
                    <b>ü§ñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</b><br>
                    <b>‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:</b> {data.get("disease", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")}<br>
                    <b>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</b> {data.get("‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")}<br>
                    <b>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö:</b> {data.get("‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")}<br>
                    <b>‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:</b> {data.get("‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")}<br>
                    <b>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</b> {data.get("reason", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")}
                </div>
                """
                st.markdown(html, unsafe_allow_html=True)
            except Exception:
                st.markdown(f"<div class='chat-bubble chat-bot'><b>ü§ñ ‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå:</b> {msg['content']}</div>", unsafe_allow_html=True)

    st.markdown("---")
    st.caption("üå± ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡∏° Future Lab | ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ä‡∏ï‡∏ö‡∏≠‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡πÄ‡∏•‡∏°‡∏≠‡∏ô (Citrus AI Expert)")

if __name__ == "__main__":
    main()
